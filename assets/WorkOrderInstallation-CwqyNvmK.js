import{d as Le,g as Ne,u as Fe,Y as Oe,v as je,c as ze,x as Me,r as c,J as I,y as Pe,f as $,w as t,al as He,ae as Ge,af as We,ag as Je,ah as Ye,T as Ze,S as Ke,D as Qe,am as le,o as D,k as C,h as e,p as K,z as Xe,F as se,n as x,j as d,G as ne,i as be,$ as et,a0 as tt,t as T,I as L,_ as at,e as u,Z as lt,M as st,an as oe,ao as nt}from"./index-BFEiEqzV.js";import{L as ot}from"./LayoutSinglePage-DJUeRI8X.js";import{R as rt,_ as it}from"./ApproverHistoryLog-BtQqsB8J.js";import{R as ut,_ as ct}from"./RequestDetails-DTjkJGRN.js";import{p as dt}from"./permitted-DHah7rlL.js";import{u as mt}from"./getUsers-CkOTfKF4.js";import{_ as pt,a as vt}from"./getActionsTaken-CbFwF999.js";import{_ as _t}from"./ServiceReportForm-BE1qAYNV.js";import{s as ke,a as ft}from"./department-IKZ5hSBF.js";import"./topBarUserProfile-DObMqA0B.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./lodash-ByxqToh2.js";import"./vue3-datatable-4DUKYgRc.js";const yt=C("h5",null,"Delegate Engineer",-1),gt={class:"small text-disabled"},bt={class:"small text-primary",style:{"font-size":"12px"}},kt={key:0,class:"text-disabled"},wt={class:"d-flex"},Nt={__name:"WorkOrderInstallation",setup(xt){var ge;const R=Le.useToast();Ne().currentUserRole;const{can:N}=dt(),we=Fe(),xe=Oe(),{width:qe}=je(),Q=ze(),F=Me(),O=c("equipments"),re=c(!1),j=c(!1),U=c(!1),g=c(!1),f=c(!1),z=parseInt(xe.params.id),X=c(""),M=c(""),ie=o=>{M.value=o,U.value=!0},De=[{title:"Back",disabled:!1,href:"/equipment-handling",display:"block"},{title:"Equipment Handling",disabled:!0,href:"",display:"none"},{title:"Work Order",disabled:!0,href:"",display:"none"}],Se=o=>{!o.disabled&&o.href&&we.push(o.href)},{engineers:Re}=mt(),ee=c(""),Ve=async()=>{var l,i;f.value=!0;const{valid:o}=await re.value.validate();if(!o){f.value=!1;return}try{const m=await F.post("delegate-engineer",{service_id:z,assigned_to:ee.value.value});(l=m.data)!=null&&l.success?(R.success("Successfully delegated"),H()):(i=m==null?void 0:m.data)!=null&&i.exist&&R.warning("Request already exist.")}catch(m){alert(m)}finally{f.value=!1,j.value=!1,g.value=!1}},ue=c(!1),he=async()=>{var l;f.value=!0;const{valid:o}=await ue.value.validate();if(!o){f.value=!1;return}try{(l=(await F.post("accept-decline-delegate",{service_id:z,delegation_id:q.value.id,status:M.value,remarks:X.value})).data)!=null&&l.success&&(R.success("Successful"),H())}catch(i){alert(i)}finally{f.value=!1,U.value=!1}},ce=c(null),V=c({status_after_service:"",fields:[],spareparts:[],remarks:""}),de=c(null),Ae=async()=>{var m,y,S,p;if(f.value=!0,g.value=!0,!await((m=ce.value)==null?void 0:m.validateServiceForm())){f.value=!1,g.value=!1;return}if(((y=V.value.fields)==null?void 0:y.length)===0){R.error("Required actions taken"),f.value=!1,g.value=!1;return}const l=(p=(S=V.value)==null?void 0:S.fields)==null?void 0:p.some(n=>typeof n.action=="string"?n.action.trim()==="":n.action===void 0||n===null),i=I(()=>{var n,v;return(v=(n=V.value)==null?void 0:n.spareparts)!=null&&v.length?V.value.spareparts.some(b=>[b.qty,b.dr,b.si].some(s=>s==null||typeof s=="string"&&s.trim()==="")):!1});if(l||i.value){f.value=!1,g.value=!1,R.error("Please fill in required fields");return}try{const n=await F.post("mark_as_completed",{id:z,delegation_id:de.value,...V.value});n.data&&n.data.success?(R.success("Operation completed successfully"),H()):R.error(n.data.error)}catch(n){console.log(n)}finally{f.value=!1,g.value=!1}},P=c(!1),h=c({}),me=c({}),q=c({}),pe=c({}),ve=c([]),_e=c([]),te=c([]),fe=c([]),H=async()=>{var o,l,i,m,y,S,p,n,v;try{P.value=!0;const b=await F.get("get-specific-equipment-handling",{params:{service_id:z,module_type:He}});if((o=b==null?void 0:b.data)!=null&&o.request){const s=(l=b.data)==null?void 0:l.request;h.value=s,me.value={full_name:(i=s.users)==null?void 0:i.full_name,institution:(m=s.institution)==null?void 0:m.name,address:(y=s.institution)==null?void 0:y.address,proposed_delivery_date:s==null?void 0:s.proposed_delivery_date,created_at:s==null?void 0:s.created_at},q.value=s.task_delegation,ve.value=(S=s.task_delegation)==null?void 0:S.actions_taken,_e.value=(p=s.task_delegation)==null?void 0:p.spareparts,pe.value=s.latest_task_delegation,te.value=s.equipments,fe.value=(n=s.approval_logs)==null?void 0:n.filter(r=>![18,19,20].includes(r.level)&&r.acted_at!==null).map(r=>{var J,Y,A,Z;const G=(J=r==null?void 0:r.approvers)==null?void 0:J.filter(_=>{var w;return((w=_.users)==null?void 0:w.department)===ke}),B=(Y=r==null?void 0:r.approvers)==null?void 0:Y.filter(_=>{var w;return((w=_.users)==null?void 0:w.department)===ft}),W=(A=r==null?void 0:r.approvers)==null?void 0:A.filter(_=>_.satellite===(s==null?void 0:s.satellite)),ae=(s==null?void 0:s.equipments.map(_=>{var w;return(w=_.master_data)==null?void 0:w.sbu}))||[],k=G.filter(_=>ae.includes(_.sbu));return r.level===Ge?{...r,driver:s==null?void 0:s.driver}:r.level===We?((Z=s.users)==null?void 0:Z.department)===ke?{...r,approvers:k}:{...r,approvers:B}:r.level===Je?{...r,approvers:k}:Ye.includes(r.level)?{...r,approvers:W}:r}),de.value=(v=s==null?void 0:s.task_delegation)==null?void 0:v.id}else alert("Something went wrong")}catch(b){console.log(b)}finally{P.value=!1}},Ce=[Ze,Ke,Qe],Ee=(ge=Q.user.user_roles.find(o=>Ce.includes(o.role_id)))==null?void 0:ge.SBU,Te=I(()=>te.value.map(o=>{var l;return(l=o.master_data)==null?void 0:l.sbu})),Ue=I(()=>{var o;return!!(h.value.main_status===le&&Te.value.includes(Ee)&&(!q.value||((o=q.value)==null?void 0:o.status)==="Declined"))}),Be=I(()=>{var m,y;const o=(m=q.value)==null?void 0:m.assigned_to,l=((y=q.value)==null?void 0:y.status)==="Delegated",i=Q.user.id;return h.value.main_status===le&&o===i&&l}),ye=I(()=>{var m,y;const o=(m=q.value)==null?void 0:m.assigned_to,l=((y=q.value)==null?void 0:y.status)==="Accepted",i=Q.user.id;return h.value.main_status===le&&o===i&&l});return Pe(()=>{H()}),(o,l)=>{const i=u("v-icon"),m=u("v-breadcrumbs-item"),y=u("v-breadcrumbs"),S=u("v-spacer"),p=u("v-btn"),n=u("v-col"),v=u("v-row"),b=u("v-list-item-title"),s=u("v-list-item"),r=u("v-combobox"),G=u("v-form"),B=u("v-card"),W=u("v-dialog"),ae=u("v-textarea"),k=u("v-skeleton-loader"),J=u("v-tooltip"),Y=u("v-chip"),A=u("v-tab"),Z=u("v-tabs"),_=u("v-window-item"),w=u("v-window"),Ie=u("v-card-text"),$e=u("v-container");return D(),$(ot,null,{topBarFixed:t(()=>[C("div",null,[e(y,{class:"pt-7"},{default:t(()=>[(D(),K(se,null,Xe(De,(a,E)=>e(m,{key:E,class:lt({"custom-pointer":!a.disabled}),style:st({display:x(qe)<=768?a.display:""}),onClick:Dt=>Se(a),disabled:a.disabled},{default:t(()=>[d(T(a.title)+" ",1),e(i,{class:"ml-1",icon:"mdi-chevron-right"})]),_:2},1032,["class","style","onClick","disabled"])),64))]),_:1})]),e(S),x(N)("delegate",x(oe))&&Ue.value?(D(),$(W,{key:0,modelValue:j.value,"onUpdate:modelValue":l[2]||(l[2]=a=>j.value=a),"max-width":"600",persistent:""},{activator:t(({props:a})=>[e(p,ne({type:"button"},a,{loading:P.value,disabled:g.value,color:"primary",variant:"flat",class:"text-none btnSubmit"}),{default:t(()=>[e(i,{class:"mr-2"},{default:t(()=>[d("mdi-account-arrow-left-outline")]),_:1}),d(" Delegate Engineer ")]),_:2},1040,["loading","disabled"])]),default:t(()=>[e(B,{class:"pa-5"},{default:t(()=>[e(G,{onSubmit:be(Ve,["prevent"]),ref_key:"form",ref:re},{default:t(()=>[e(v,null,{default:t(()=>[e(n,null,{default:t(()=>[yt]),_:1})]),_:1}),e(v,null,{default:t(()=>[e(n,{class:"d-flex justify-center"},{default:t(()=>[e(r,{color:"primary",class:"mt-5",modelValue:ee.value,"onUpdate:modelValue":l[0]||(l[0]=a=>ee.value=a),clearable:"",label:"Delegate to",placeholder:"Delegate to",density:"compact",items:x(Re),variant:"outlined",itemValue:"value",rules:[a=>!!a||"Required",a=>a.key!==void 0?!0:"Select one of the options listed"],itemTitle:"key"},{item:t(({item:a,props:E})=>[e(s,et(tt(E)),{default:t(()=>[e(b,null,{default:t(()=>[C("p",gt,"SBU "+T(a.raw.sbu),1)]),_:2},1024)]),_:2},1040)]),selection:t(({item:a,index:E})=>[C("span",bt,[C("b",null,T(a.title),1),d(),a.title?(D(),K("span",kt,"- [SBU : "+T(a.raw.sbu)+"]",1)):L("",!0)])]),_:1},8,["modelValue","items","rules"])]),_:1})]),_:1}),e(v,{justify:"end",class:"mt-7 mb-5"},{default:t(()=>[e(p,{variant:"plain",onClick:l[1]||(l[1]=a=>j.value=!1),color:"primary",class:"text-none mr-2"},{default:t(()=>[d(" Cancel")]),_:1}),e(p,{type:"submit",loading:f.value,disabled:g.value,color:"#191970",flat:"",class:"text-none bg-primary mr-5"},{default:t(()=>[e(i,{class:"mr-2"},{default:t(()=>[d("mdi-check")]),_:1}),d(" Delegate")]),_:1},8,["loading","disabled"])]),_:1})]),_:1},512)]),_:1})]),_:1},8,["modelValue"])):L("",!0),x(N)("installer",x(oe))&&Be.value?(D(),$(W,{key:1,modelValue:U.value,"onUpdate:modelValue":l[7]||(l[7]=a=>U.value=a),"max-width":"600",persistent:""},{activator:t(({props:a})=>[e(p,ne({type:"button"},a,{disabled:g.value,color:"primary",variant:"plain",class:"text-none mr-2",onClick:l[3]||(l[3]=E=>ie("declined"))}),{default:t(()=>[d(" Decline ")]),_:2},1040,["disabled"]),e(p,ne({type:"button"},a,{disabled:g.value,color:"primary",variant:"flat",class:"text-none",onClick:l[4]||(l[4]=E=>ie("accepted"))}),{default:t(()=>[e(i,{class:"mr-2"},{default:t(()=>[d("mdi-check")]),_:1}),d(" Accept ")]),_:2},1040,["disabled"])]),default:t(()=>[e(B,{class:"pa-5"},{default:t(()=>[e(G,{onSubmit:be(he,["prevent"]),ref_key:"formAcceptDecline",ref:ue},{default:t(()=>[e(v,null,{default:t(()=>[e(n,{class:"d-flex justify-center"},{default:t(()=>[e(ae,{modelValue:X.value,"onUpdate:modelValue":l[5]||(l[5]=a=>X.value=a),rules:M.value==="declined"?[a=>!!a||"Required"]:[],label:"Remarks",placeholder:"Remarks",dense:"",rows:"3",variant:"outlined",class:"mt-5 w-100"},null,8,["modelValue","rules"])]),_:1})]),_:1}),e(v,{justify:"end",class:"mt-7 mb-5"},{default:t(()=>[e(p,{variant:"plain",onClick:l[6]||(l[6]=a=>U.value=!1),color:"primary",class:"text-none mr-2"},{default:t(()=>[d(" Cancel")]),_:1}),e(p,{type:"submit",loading:f.value,disabled:g.value,color:"primary",variant:"flat",class:"text-none mr-5"},{default:t(()=>[d(T(M.value==="accepted"?"Accept":"Decline"),1)]),_:1},8,["loading","disabled"])]),_:1})]),_:1},512)]),_:1})]),_:1},8,["modelValue"])):L("",!0),x(N)("installer",x(oe))&&ye.value?(D(),$(p,{key:2,onClick:Ae,text:"Mark as Completed",disabled:g.value,color:"primary",variant:"flat",class:"text-none mr-5"},null,8,["disabled"])):L("",!0)]),default:t(()=>[e($e,{class:"container-form mt-3"},{default:t(()=>[P.value?(D(),K(se,{key:0},[e(v,null,{default:t(()=>[e(n,{cols:"6"},{default:t(()=>[e(k,{type:"list-item-two-line"})]),_:1}),e(n,{cols:"6"},{default:t(()=>[e(k,{type:"list-item-two-line"})]),_:1})]),_:1}),e(v,null,{default:t(()=>[e(n,{cols:"4"},{default:t(()=>[e(k,{type:"list-item-two-line"})]),_:1}),e(n,{cols:"4"},{default:t(()=>[e(k,{type:"list-item-two-line"})]),_:1}),e(n,{cols:"4"},{default:t(()=>[e(k,{type:"list-item-two-line"})]),_:1})]),_:1}),e(v,null,{default:t(()=>[e(n,{cols:"4"},{default:t(()=>[e(k,{type:"list-item-two-line"})]),_:1}),e(n,{cols:"4"},{default:t(()=>[e(k,{type:"list-item-two-line"})]),_:1}),e(n,{cols:"4"},{default:t(()=>[e(k,{type:"list-item-two-line"})]),_:1})]),_:1})],64)):(D(),K(se,{key:1},[e(at,{name:"slide-x-transition"},{default:t(()=>[e(Y,{class:"ma-2 mt-5",color:"purple",label:""},{default:t(()=>{var a;return[e(J,{activator:"parent",location:"bottom"},{default:t(()=>[d("Status of Installation")]),_:1}),d("  "+T(((a=pe.value)==null?void 0:a.status)??"---"),1)]}),_:1})]),_:1}),x(N)("installer",x(nt))&&ye.value?(D(),$(_t,{key:0,modelValue:V.value,"onUpdate:modelValue":l[8]||(l[8]=a=>V.value=a),ref_key:"serviceFormRef",ref:ce},null,8,["modelValue"])):L("",!0),e(ut,{request_data:me.value},null,8,["request_data"]),e(rt,{request_data:h.value},null,8,["request_data"])],64)),e(B,{class:"mt-10"},{default:t(()=>[e(Z,{modelValue:O.value,"onUpdate:modelValue":l[9]||(l[9]=a=>O.value=a),density:"compact",class:"border-b-sm"},{default:t(()=>[C("div",wt,[e(A,{value:"equipments",class:"text-none"},{default:t(()=>[e(i,{class:"mr-2"},{default:t(()=>[d("mdi-hammer-screwdriver")]),_:1}),d(" Requested Equipments")]),_:1}),e(A,{value:"history",class:"text-none"},{default:t(()=>[e(i,{class:"mr-2"},{default:t(()=>[d("mdi-account-details")]),_:1}),d(" Approval Requirements")]),_:1})]),e(S),C("div",null,[e(A,{value:"delegation_details",class:"text-none",color:"primary"},{default:t(()=>[e(i,{class:"mr-2"},{default:t(()=>[d("mdi-gesture-tap-button")]),_:1}),d(" Delegation Details")]),_:1}),e(A,{value:"service_report",class:"text-none",color:"primary"},{default:t(()=>[e(i,{class:"mr-2"},{default:t(()=>[d("mdi-poll")]),_:1}),d(" Service Report")]),_:1})])]),_:1},8,["modelValue"]),e(Ie,null,{default:t(()=>[e(w,{modelValue:O.value,"onUpdate:modelValue":l[10]||(l[10]=a=>O.value=a)},{default:t(()=>[e(_,{value:"equipments"},{default:t(()=>[e(ct,{equipments:te.value},null,8,["equipments"])]),_:1}),e(_,{value:"history"},{default:t(()=>[e(it,{history:fe.value,status:h.value.main_status},null,8,["history","status"])]),_:1}),e(_,{value:"delegation_details"},{default:t(()=>[e(pt,{internalData:h.value},null,8,["internalData"])]),_:1}),e(_,{value:"service_report"},{default:t(()=>[e(vt,{task_delegation:q.value,actions_taken:ve.value,spareparts:_e.value},null,8,["task_delegation","actions_taken","spareparts"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})}}};export{Nt as default};
