import{d as Te,r as o,af as Ye,x as $e,e as s,o as h,f as se,w as t,h as e,G as ge,j as c,i as he,n as X,$ as Ze,a0 as Qe,k as S,t as $,p as A,I as oe,g as Xe,u as et,Y as tt,v as at,c as lt,L as Z,J as Q,V as st,y as ot,ag as rt,ah as Ue,ai as Pe,aj as _e,ak as Ee,al as Ce,am as fe,a6 as nt,a4 as it,z as ut,F as le,_ as ct,a8 as dt,ab as Ne,an as be,Z as pt,M as vt,N as mt,O as _t}from"./index-BVXPU9zS.js";import{L as ft}from"./LayoutSinglePage-Bv3n2_4P.js";import{R as bt,_ as yt}from"./ApproverHistoryLog-BcS5RGgC.js";import{R as gt,_ as ht}from"./RequestDetails-C2m77Wo2.js";import{p as St}from"./permitted-CQa1RmFG.js";import{u as qt}from"./getUsers-CWxP2GaZ.js";import{s as ye,a as wt}from"./department-IKZ5hSBF.js";import{P as xt}from"./PMPrint-CbXTz5lq.js";import{_ as kt}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./topBarUserProfile-DtdqdVcI.js";import"./maintenance-D6-EqnL4.js";import"./lodash-CwzxlBFL.js";const Vt=S("h5",{style:{"font-weight":"500",color:"#191970"}},[S("span",null,"Service Department - Internal Servicing")],-1),Rt=S("p",{class:"small mt-2 mb-3"}," If you select Start the Internal Servicing, the process will pause and wait until the internal servicing is completed before proceeding further ",-1),Dt=S("h5",{class:"mt-3",style:{"font-weight":"500",color:"#191970"}},"Internal Servicing - Delegation of Service",-1),It={class:"small text-disabled"},At={class:"small text-primary",style:{"font-size":"12px"}},Bt={key:0,class:"text-disabled"},Ut={__name:"InternalServicingDelegation",props:{service_id:{type:Number}},emits:["refresh"],setup(B,{emit:U}){const re=Te.useToast(),x=o(!1),M=o(""),P=o(!1),E=o(!1),ne=o(!1),b=Ye("disableButton",null),L=U,C=$e(),ee=B,{engineers:O}=qt(),z=async()=>{E.value=!0;const{valid:y}=await P.value.validate();if(!y){E.value=!1;return}try{const d=await C.post("internal-process",{service_id:ee.service_id,assigned_to:M.value.value});d.data&&d.data.success?(re.success("Successfully delegated"),typeof b=="function"&&b(),L("refresh")):d.data&&d.data.exist_service_id&&re.warning("Request already exist.")}catch(d){alert(d)}finally{E.value=!1,x.value=!1}};return(y,d)=>{const k=s("v-col"),N=s("v-row"),j=s("v-icon"),V=s("v-btn"),te=s("v-divider"),q=s("v-list-item-title"),ie=s("v-list-item"),ue=s("v-combobox"),ce=s("v-form"),F=s("v-card"),H=s("v-dialog");return h(),se(F,{flat:"",class:"mb-5 mt-7 pt-3 pb-1",color:"info",variant:"tonal"},{default:t(()=>[e(k,{cols:"12"},{default:t(()=>[e(N,null,{default:t(()=>[e(k,{cols:"12"},{default:t(()=>[Vt,Rt]),_:1})]),_:1}),e(H,{modelValue:x.value,"onUpdate:modelValue":d[2]||(d[2]=v=>x.value=v),"max-width":"500",persistent:""},{activator:t(({props:v})=>[e(V,ge({type:"button",variant:"tonal"},v,{color:"primary",class:"text-none btnSubmit mt-3"}),{default:t(()=>[e(j,{class:"mr-2"},{default:t(()=>[c("mdi-transfer-right")]),_:1}),c(" Start Internal Servicing")]),_:2},1040)]),default:t(()=>[e(F,null,{default:t(()=>[e(ce,{onSubmit:he(z,["prevent"]),ref_key:"form",ref:P},{default:t(()=>[e(k,{cols:"12"},{default:t(()=>[Dt,e(te),e(ue,{color:"primary",class:"mt-5",modelValue:M.value,"onUpdate:modelValue":d[0]||(d[0]=v=>M.value=v),clearable:"",label:"Delegate to",placeholder:"Delegate to",density:"compact",items:X(O),variant:"outlined",itemValue:"value",rules:[v=>!!v||"Required",v=>v.key!==void 0?!0:"Select one of the options listed"],itemTitle:"key"},{item:t(({item:v,props:T})=>[e(ie,Ze(Qe(T)),{default:t(()=>[e(q,null,{default:t(()=>[S("p",It,"SBU "+$(v.raw.sbu),1)]),_:2},1024)]),_:2},1040)]),selection:t(({item:v,index:T})=>[S("span",At,[S("b",null,$(v.title),1),c(),v.title?(h(),A("span",Bt,"- [SBU : "+$(v.raw.sbu)+"]",1)):oe("",!0)])]),_:1},8,["modelValue","items","rules"])]),_:1}),e(te,{class:"mb-5"}),e(N,{justify:"end",class:"mb-3"},{default:t(()=>[e(V,{onClick:d[1]||(d[1]=v=>x.value=!1),elevation:"0",size:"small",class:"text-none mr-2"},{default:t(()=>[c(" Cancel")]),_:1}),e(V,{type:"submit",size:"small",loading:E.value,disabled:ne.value,color:"#191970",class:"text-none bg-primary mr-5"},{default:t(()=>[e(j,{class:"mr-2"},{default:t(()=>[c("mdi-check")]),_:1}),c(" Delegate")]),_:1},8,["loading","disabled"])]),_:1})]),_:1},512)]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})}}},Pt=B=>(mt("data-v-068221c0"),B=B(),_t(),B),Et={key:0},Ct=Pt(()=>S("p",{class:"text-error"},"* Internal Processing in Progress",-1)),Nt=[Ct],Tt={key:1},$t={__name:"WorkOrderApprover",setup(B){var Re,De;const U=Te.useToast(),x=Xe().currentUserRole,{can:M}=St(),P=et(),E=tt(),{width:ne}=at(),b=lt(),L=$e(),C=o("equipments"),ee=o(!1),O=o(!1),z=o(!1);o(!1);const y=o(!1),d=o(!1),k=parseInt(E.params.id),N=o([]),j=o(!1),V=o("");o(null),o(0);const te=o(""),q=o({receiving_option:"",final_installation_date:"",driver:""}),ie=[{title:"Back",disabled:!1,href:"/equipment-handling",display:"block"},{title:"Equipment Handling",disabled:!0,href:"",display:"none"},{title:"Work Order",disabled:!0,href:"",display:"none"}],ue=r=>{!r.disabled&&r.href&&P.push(r.href)},ce=async()=>{var a;if(d.value=!0,b.user.approval_level.includes(be)&&((a=p.value)==null?void 0:a.level)===be&&!j.value){U.error("Please ensure all serial number fields are filled in"),d.value=!1;return}const{valid:r}=await ee.value.validate();if(!r){d.value=!1;return}try{const i=await L.post("approve-request",{id:b.user.id,serial:N.value,service_id:k,engineer:te.value.value,level:p.value.level,remark:V.value,...q.value});i.data&&i.data.success&&(y.value=!0,U.success("Approved successfully"),P.push("/equipment-handling"))}catch(i){i.response.data&&i.response.data.errorMisMatch&&(U.error(i.response.data.errorMisMatch),pe()),console.log(i)}finally{d.value=!1}},F=o(!1),H=o(""),v=async()=>{y.value=!0,d.value=!0;const{valid:r}=F.value.validate();if(!r){y.value=!1,d.value=!1;return}try{const a=await L.post("disapprove-request",{service_id:k,remark:H.value});a.data&&a.data.success&&(U.success("Disapproval completed successfully"),P.push("/equipment-handling"))}catch(a){console.log(a)}finally{y.value=!1,d.value=!1}},T=o(!1),p=o({}),Se=o({});o({});const de=o([]),qe=o([]),we=o([]),xe=o([]),pe=async()=>{var r,a,i,R,w;try{T.value=!0;const m=await L.get("get-specific-equipment-handling",{params:{service_id:k,module_type:rt}});if((r=m==null?void 0:m.data)!=null&&r.request){const u=m.data.request;p.value=u,Se.value={full_name:(a=u.users)==null?void 0:a.full_name,institution:(i=u.institution)==null?void 0:i.name,address:(R=u.institution)==null?void 0:R.address,proposed_delivery_date:u.proposed_delivery_date,created_at:u.created_at},de.value=u.equipments,qe.value=u.peripherals,we.value=(w=u.approval_logs)==null?void 0:w.filter(n=>![18,19,20].includes(n.level)&&n.acted_at!==null).map(n=>{var J,K,ae,Y;const D=(J=n==null?void 0:n.approvers)==null?void 0:J.filter(g=>{var _;return((_=g.users)==null?void 0:_.department)===ye}),f=(K=n==null?void 0:n.approvers)==null?void 0:K.filter(g=>{var _;return((_=g.users)==null?void 0:_.department)===wt}),W=(ae=n==null?void 0:n.approvers)==null?void 0:ae.filter(g=>g.satellite===(u==null?void 0:u.satellite)),I=(u==null?void 0:u.equipments.map(g=>{var _;return(_=g.master_data)==null?void 0:_.sbu}))||[],G=D.filter(g=>I.includes(g.sbu));return n.level===Ue?{...n,driver:u==null?void 0:u.driver}:n.level===Pe?((Y=u.users)==null?void 0:Y.department)===ye?{...n,approvers:G}:{...n,approvers:f}:n.level===_e?{...n,approvers:G}:Ee.includes(n.level)?{...n,approvers:W}:n}),xe.value=u.users}else alert("Something went wrong")}catch(m){console.log(m)}finally{T.value=!1}},Me=r=>{var a;N.value=Array.from(r),j.value=(a=N.value)==null?void 0:a.every(i=>i.serial&&i.serial.trim()!=="")},ve=(Re=b.user.user_roles.find(r=>r.role_id===Z))==null?void 0:Re.SBU,Le=(De=b.user.user_roles.find(r=>r.role_id===Z))==null?void 0:De.satellite,me=Q(()=>de.value.map(r=>{var a;return(a=r.master_data)==null?void 0:a.sbu})),Oe=Q(()=>{var r,a;return p.value.level===_e&&p.value.main_status!==Ce&&x===Z?(me.value.includes(ve)||((a=(r=b.user)==null?void 0:r.user_roles)==null?void 0:a.some(i=>i.role_id===fe)))&&!p.value.bypass:!1}),ze=Q(()=>{var r,a,i,R,w,m,u,n,D;return b.user.approval_level.includes(p.value.level)&&x===Z&&((r=p.value)==null?void 0:r.main_status)!==nt?p.value.level===Pe?((a=b.user)==null?void 0:a.department)===ye?me.value.includes(ve)||((R=(i=b.user)==null?void 0:i.user_roles)==null?void 0:R.some(f=>f.role_id===fe)):((w=b.user)==null?void 0:w.department)===((m=xe.value)==null?void 0:m.department):p.value.level===_e?me.value.includes(ve)||((n=(u=b.user)==null?void 0:u.user_roles)==null?void 0:n.some(f=>f.role_id===fe)):Ee.includes(p.value.level)?((D=p.value)==null?void 0:D.satellite)===Le:!0:!1}),je=Q(()=>p.value.main_status===Ce),Fe=Q(()=>{var r;return p.value.level===Ue&&x===Z&&((r=p.value)==null?void 0:r.request_type)===it}),ke=o(0),Ve=()=>{pe(),ke.value+=1};return st("disableButton",()=>{y.value=!0}),ot(async()=>{y.value=!0,b.user.approval_level!==1&&(y.value=!1),y.value=!1,pe()}),(r,a)=>{const i=s("v-icon"),R=s("v-breadcrumbs-item"),w=s("v-tooltip"),m=s("v-btn"),u=s("v-breadcrumbs"),n=s("v-spacer"),D=s("v-textarea"),f=s("v-col"),W=s("v-row"),I=s("v-card"),G=s("v-form"),J=s("v-dialog"),K=s("v-radio"),ae=s("v-radio-group"),Y=s("v-text-field"),g=s("v-divider"),_=s("v-skeleton-loader"),Ie=s("v-chip"),Ae=s("v-tab"),He=s("v-tabs"),Be=s("v-window-item"),We=s("v-window"),Ge=s("v-card-text"),Je=s("v-container");return h(),se(ft,null,{topBarFixed:t(()=>[S("div",null,[e(u,{class:"pt-7"},{default:t(()=>[(h(),A(le,null,ut(ie,(l,Ke)=>e(R,{key:Ke,class:pt({"custom-pointer":!l.disabled}),style:vt({display:X(ne)<=768?l.display:""}),onClick:Lt=>ue(l),disabled:l.disabled},{default:t(()=>[c($(l.title)+" ",1),e(i,{class:"ml-1",icon:"mdi-chevron-right"})]),_:2},1032,["class","style","onClick","disabled"])),64)),e(m,{onClick:Ve,variant:"plain",color:"grey"},{default:t(()=>[e(i,null,{default:t(()=>[c("mdi-refresh")]),_:1}),e(w,{activator:"parent",location:"bottom"},{default:t(()=>[c("Refresh")]),_:1})]),_:1})]),_:1})]),e(n),je.value?(h(),A("div",Et,Nt)):(h(),A("div",Tt,[X(M)("approve","Equipment Handling")&&ze.value?(h(),A(le,{key:0},[e(J,{modelValue:O.value,"onUpdate:modelValue":a[2]||(a[2]=l=>O.value=l),"max-width":"600",persistent:""},{activator:t(({props:l})=>[e(m,ge({disabled:y.value},l,{color:"primary",variant:"plain",class:"text-none mr-2"}),{default:t(()=>[c(" Disapprove")]),_:2},1040,["disabled"])]),default:t(()=>[e(G,{onSubmit:he(v,["prevent"]),ref_key:"formDisapprove",ref:F},{default:t(()=>[e(I,{text:"",title:"Disapprove"},{actions:t(()=>[e(W,{justify:"end"},{default:t(()=>[e(m,{onClick:a[1]||(a[1]=l=>O.value=!1),class:"text-none mr-2"},{default:t(()=>[c(" Cancel")]),_:1}),e(m,{type:"submit",color:"primary",elevation:"2",class:"text-none mr-3",style:{"background-color":"#191970",color:"#fff!important"}},{default:t(()=>[c("Disapprove")]),_:1})]),_:1})]),default:t(()=>[e(f,{cols:"12"},{default:t(()=>[e(D,{class:"mr-2 ml-2",modelValue:H.value,"onUpdate:modelValue":a[0]||(a[0]=l=>H.value=l),rules:[l=>!!(l!=null&&l.trim())||"Please provide a reason for disapproval"],clearable:"",label:"Reason of Disapproval",color:"primary",variant:"outlined"},null,8,["modelValue","rules"])]),_:1})]),_:1})]),_:1},512)]),_:1},8,["modelValue"]),e(J,{modelValue:z.value,"onUpdate:modelValue":a[8]||(a[8]=l=>z.value=l),"max-width":"600",persistent:""},{activator:t(({props:l})=>[e(m,ge({type:"button"},l,{disabled:y.value,color:"primary",variant:"flat",class:"text-none btnSubmit"}),{default:t(()=>[e(i,{class:"mr-2"},{default:t(()=>[c("mdi-check")]),_:1}),c(" Approve")]),_:2},1040,["disabled"])]),default:t(()=>[e(I,{text:"",title:"Approve"},{default:t(()=>[e(G,{onSubmit:he(ce,["prevent"]),ref_key:"form",ref:ee},{default:t(()=>[e(f,{cols:"12"},{default:t(()=>[e(D,{class:"mr-2 ml-2",modelValue:V.value,"onUpdate:modelValue":a[3]||(a[3]=l=>V.value=l),clearable:"",label:"Remarks (optional)",color:"primary",variant:"outlined"},null,8,["modelValue"]),Fe.value?(h(),A(le,{key:0},[e(I,{class:"mr-2 ml-2 mt-5"},{default:t(()=>[e(ae,{modelValue:q.value.receiving_option,"onUpdate:modelValue":a[4]||(a[4]=l=>q.value.receiving_option=l),rules:[l=>!!l||"Required"],label:"Set receiving option",color:"primary"},{default:t(()=>[e(K,{label:"Door to Door",value:"door"}),e(K,{label:"Pickup",value:"pickup"})]),_:1},8,["modelValue","rules"])]),_:1}),e(Y,{type:"date",class:"mr-2 ml-2 mt-5",modelValue:q.value.final_installation_date,"onUpdate:modelValue":a[5]||(a[5]=l=>q.value.final_installation_date=l),variant:"outlined",color:"primary",density:"compact",rules:[l=>!!l||"Required"],label:"Final Installation Date"},null,8,["modelValue","rules"]),e(Y,{class:"mr-2 ml-2 mt-5",modelValue:q.value.driver,"onUpdate:modelValue":a[6]||(a[6]=l=>q.value.driver=l),variant:"outlined",color:"primary",density:"compact",rules:[l=>!!l||"Required"],label:"Driver"},null,8,["modelValue","rules"])],64)):oe("",!0)]),_:1}),e(g),e(W,{justify:"end",class:"mt-7 mb-5 pr-3"},{default:t(()=>[e(m,{variant:"plain",onClick:a[7]||(a[7]=l=>z.value=!1),color:"primary",class:"text-none mr-2"},{default:t(()=>[c(" Cancel")]),_:1}),e(m,{type:"submit",loading:d.value,disabled:y.value,color:"#191970",flat:"",class:"text-none bg-primary mr-5"},{default:t(()=>[e(i,{class:"mr-2"},{default:t(()=>[c("mdi-check")]),_:1}),c(" Approve")]),_:1},8,["loading","disabled"])]),_:1})]),_:1},512)]),_:1})]),_:1},8,["modelValue"])],64)):oe("",!0)]))]),default:t(()=>[e(Je,{class:"container-form mt-3"},{default:t(()=>[T.value?(h(),se(W,{key:0},{default:t(()=>[e(f,{cols:"6"},{default:t(()=>[e(_,{type:"list-item-two-line"})]),_:1}),e(f,{cols:"6"},{default:t(()=>[e(_,{type:"list-item-two-line"})]),_:1}),e(f,{cols:"4"},{default:t(()=>[e(_,{type:"list-item-two-line"})]),_:1}),e(f,{cols:"4"},{default:t(()=>[e(_,{type:"list-item-two-line"})]),_:1}),e(f,{cols:"4"},{default:t(()=>[e(_,{type:"list-item-two-line"})]),_:1}),e(f,{cols:"4"},{default:t(()=>[e(_,{type:"list-item-two-line"})]),_:1}),e(f,{cols:"4"},{default:t(()=>[e(_,{type:"list-item-two-line"})]),_:1}),e(f,{cols:"4"},{default:t(()=>[e(_,{type:"list-item-two-line"})]),_:1})]),_:1})):(h(),A(le,{key:1},[e(ct,{name:"slide-x-transition"},{default:t(()=>[e(I,{class:"mt-5 statusVCard",elevation:"0"},{default:t(()=>[e(Ie,{class:"ma-2",color:"purple",label:""},{default:t(()=>[S("i",null," "+$(dt(p.value.level,1)??"---"),1),e(w,{activator:"parent",location:"bottom"},{default:t(()=>[c("Pending approval")]),_:1})]),_:1}),e(Ie,{class:"ma-2",color:Ne(p.value.main_status).color,label:""},{default:t(()=>[e(w,{activator:"parent",location:"bottom"},{default:t(()=>[c("Status")]),_:1}),S("strong",null," "+$(Ne(p.value.main_status).text),1)]),_:1},8,["color"]),e(xt,{data:p.value},null,8,["data"])]),_:1})]),_:1}),Oe.value?(h(),se(Ut,{service_id:X(k),onRefresh:Ve,key:ke.value},null,8,["service_id"])):oe("",!0),e(gt,{request_data:Se.value},null,8,["request_data"]),e(bt,{request_data:p.value},null,8,["request_data"])],64)),e(I,{class:"mt-10"},{default:t(()=>[e(He,{modelValue:C.value,"onUpdate:modelValue":a[9]||(a[9]=l=>C.value=l),density:"compact",class:"border-b-sm"},{default:t(()=>[e(Ae,{value:"equipments",class:"text-none"},{default:t(()=>[e(i,{class:"mr-2"},{default:t(()=>[c("mdi-hammer-screwdriver")]),_:1}),c(" Requested Equipments")]),_:1}),e(Ae,{value:"history",class:"text-none"},{default:t(()=>[e(i,{class:"mr-2"},{default:t(()=>[c("mdi-account-details")]),_:1}),c(" Approval Requirements")]),_:1})]),_:1},8,["modelValue"]),e(Ge,null,{default:t(()=>[e(We,{modelValue:C.value,"onUpdate:modelValue":a[10]||(a[10]=l=>C.value=l),disabled:!0},{default:t(()=>[e(Be,{value:"equipments"},{default:t(()=>[e(ht,{equipments:de.value,peripherals:qe.value,onSetSerial:Me,editSerial:p.value.level===X(be)},null,8,["equipments","peripherals","editSerial"])]),_:1}),e(Be,{value:"history"},{default:t(()=>[e(yt,{history:we.value,status:p.value.main_status},null,8,["history","status"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})}}},Xt=kt($t,[["__scopeId","data-v-068221c0"]]);export{Xt as default};
