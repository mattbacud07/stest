import{d as Le,g as Ne,u as Pe,Y as Me,v as je,c as Fe,x as Oe,r as d,J as B,y as ze,f as $,w as t,ag as He,ah as Ge,ai as We,aj as Je,ak as Ye,T as Ze,S as Ke,D as Qe,ac as le,am as Xe,o as D,k as V,h as e,p as Q,z as et,F as se,n as x,j as m,G as ne,i as be,$ as tt,a0 as at,t as I,I as L,_ as lt,e as u,Z as st,M as nt,a1 as oe,ao as ot}from"./index-BVXPU9zS.js";import{L as rt}from"./LayoutSinglePage-Bv3n2_4P.js";import{R as it,_ as ut}from"./ApproverHistoryLog-BcS5RGgC.js";import{R as ct,_ as dt}from"./RequestDetails-C2m77Wo2.js";import{p as mt}from"./permitted-CQa1RmFG.js";import{u as pt}from"./getUsers-CWxP2GaZ.js";import{_ as vt,a as _t,b as ft}from"./ServiceReportForm-0XtmPcpf.js";import{s as ke,a as yt}from"./department-IKZ5hSBF.js";import{P as gt}from"./PMPrint-CbXTz5lq.js";import"./topBarUserProfile-DtdqdVcI.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./lodash-CwzxlBFL.js";import"./vue3-datatable-C2ljW4qF.js";import"./maintenance-D6-EqnL4.js";const bt=V("h5",null,"Delegate Engineer",-1),kt={class:"small text-disabled"},wt={class:"small text-primary",style:{"font-size":"12px"}},xt={key:0,class:"text-disabled"},qt={class:"d-flex"},jt={__name:"WorkOrderInstallation",setup(Dt){var ge;const h=Le.useToast();Ne().currentUserRole;const{can:N}=mt(),we=Pe(),xe=Me(),{width:qe}=je(),P=Fe(),M=Oe(),j=d("equipments"),re=d(!1),F=d(!1),T=d(!1),g=d(!1),f=d(!1),O=parseInt(xe.params.id),X=d(""),z=d(""),ie=r=>{z.value=r,T.value=!0},De=[{title:"Back",disabled:!1,href:"/equipment-handling",display:"block"},{title:"Equipment Handling",disabled:!0,href:"",display:"none"},{title:"Work Order",disabled:!0,href:"",display:"none"}],Se=r=>{!r.disabled&&r.href&&we.push(r.href)},{engineers:Re}=pt(),ee=d(""),Ve=async()=>{var a,o;f.value=!0;const{valid:r}=await re.value.validate();if(!r){f.value=!1;return}try{const c=await M.post("delegate-engineer",{service_id:O,assigned_to:ee.value.value});(a=c.data)!=null&&a.success?(h.success("Successfully delegated"),G()):(o=c==null?void 0:c.data)!=null&&o.exist&&h.warning("Request already exist.")}catch(c){alert(c)}finally{f.value=!1,F.value=!1,g.value=!1}},ue=d(!1),he=async()=>{var a;f.value=!0;const{valid:r}=await ue.value.validate();if(!r){f.value=!1;return}try{(a=(await M.post("accept-decline-delegate",{service_id:O,delegation_id:q.value.id,status:z.value,remarks:X.value})).data)!=null&&a.success&&(h.success("Successful"),G())}catch(o){alert(o)}finally{f.value=!1,T.value=!1}},ce=d(null),A=d({status_after_service:"",fields:[],spareparts:[],remarks:"",complaint:"",problem:""}),de=d(null),Ae=async()=>{var c,y,R,p;if(f.value=!0,g.value=!0,!await((c=ce.value)==null?void 0:c.validateServiceForm())){f.value=!1,g.value=!1;return}if(((y=A.value.fields)==null?void 0:y.length)===0){h.error("Required actions taken"),f.value=!1,g.value=!1;return}const a=(p=(R=A.value)==null?void 0:R.fields)==null?void 0:p.some(n=>typeof n.action=="string"?n.action.trim()==="":n.action===void 0||n===null),o=B(()=>{var n,v;return(v=(n=A.value)==null?void 0:n.spareparts)!=null&&v.length?A.value.spareparts.some(b=>[b.qty,b.dr,b.si].some(s=>s==null||typeof s=="string"&&s.trim()==="")):!1});if(a||o.value){f.value=!1,g.value=!1,h.error("Please fill in required fields");return}try{const n=await M.post("mark_as_completed",{id:O,delegation_id:de.value,...A.value});n.data&&n.data.success?(h.success("Operation completed successfully"),G()):h.error(n.data.error)}catch(n){console.log(n)}finally{f.value=!1,g.value=!1}},H=d(!1),S=d({}),me=d({}),q=d({}),pe=d({}),ve=d([]),_e=d([]),te=d([]),fe=d([]),G=async()=>{var r,a,o,c,y,R,p,n,v;try{H.value=!0;const b=await M.get("get-specific-equipment-handling",{params:{service_id:O,module_type:He}});if((r=b==null?void 0:b.data)!=null&&r.request){const s=(a=b.data)==null?void 0:a.request;S.value=s,me.value={full_name:(o=s.users)==null?void 0:o.full_name,institution:(c=s.institution)==null?void 0:c.name,address:(y=s.institution)==null?void 0:y.address,proposed_delivery_date:s==null?void 0:s.proposed_delivery_date,created_at:s==null?void 0:s.created_at},q.value=s.task_delegation,ve.value=(R=s.task_delegation)==null?void 0:R.actions_taken,_e.value=(p=s.task_delegation)==null?void 0:p.spareparts,pe.value=s.latest_task_delegation,te.value=s.equipments,fe.value=(n=s.approval_logs)==null?void 0:n.filter(i=>![18,19,20].includes(i.level)&&i.acted_at!==null).map(i=>{var Y,Z,C,K;const W=(Y=i==null?void 0:i.approvers)==null?void 0:Y.filter(_=>{var w;return((w=_.users)==null?void 0:w.department)===ke}),U=(Z=i==null?void 0:i.approvers)==null?void 0:Z.filter(_=>{var w;return((w=_.users)==null?void 0:w.department)===yt}),J=(C=i==null?void 0:i.approvers)==null?void 0:C.filter(_=>_.satellite===(s==null?void 0:s.satellite)),ae=(s==null?void 0:s.equipments.map(_=>{var w;return(w=_.master_data)==null?void 0:w.sbu}))||[],k=W.filter(_=>ae.includes(_.sbu));return i.level===Ge?{...i,driver:s==null?void 0:s.driver}:i.level===We?((K=s.users)==null?void 0:K.department)===ke?{...i,approvers:k}:{...i,approvers:U}:i.level===Je?{...i,approvers:k}:Ye.includes(i.level)?{...i,approvers:J}:i}),de.value=(v=s==null?void 0:s.task_delegation)==null?void 0:v.id}else alert("Something went wrong")}catch(b){console.log(b)}finally{H.value=!1}},Ce=[Ze,Ke,Qe],Ee=(ge=P.user.user_roles.find(r=>Ce.includes(r.role_id)))==null?void 0:ge.SBU,Ie=B(()=>te.value.map(r=>{var a;return(a=r.master_data)==null?void 0:a.sbu})),Te=B(()=>{var r,a,o;return!!(S.value.main_status===le&&(Ie.value.includes(Ee)||(a=(r=P.user)==null?void 0:r.user_roles)!=null&&a.some(c=>c.role_id===Xe))&&(!q.value||((o=q.value)==null?void 0:o.status)==="Declined"))}),Ue=B(()=>{var c,y;const r=(c=q.value)==null?void 0:c.assigned_to,a=((y=q.value)==null?void 0:y.status)==="Delegated",o=P.user.id;return S.value.main_status===le&&r===o&&a}),ye=B(()=>{var c,y;const r=(c=q.value)==null?void 0:c.assigned_to,a=((y=q.value)==null?void 0:y.status)==="Accepted",o=P.user.id;return S.value.main_status===le&&r===o&&a});return ze(()=>{G()}),(r,a)=>{const o=u("v-icon"),c=u("v-breadcrumbs-item"),y=u("v-breadcrumbs"),R=u("v-spacer"),p=u("v-btn"),n=u("v-col"),v=u("v-row"),b=u("v-list-item-title"),s=u("v-list-item"),i=u("v-combobox"),W=u("v-form"),U=u("v-card"),J=u("v-dialog"),ae=u("v-textarea"),k=u("v-skeleton-loader"),Y=u("v-tooltip"),Z=u("v-chip"),C=u("v-tab"),K=u("v-tabs"),_=u("v-window-item"),w=u("v-window"),Be=u("v-card-text"),$e=u("v-container");return D(),$(rt,null,{topBarFixed:t(()=>[V("div",null,[e(y,{class:"pt-7"},{default:t(()=>[(D(),Q(se,null,et(De,(l,E)=>e(c,{key:E,class:st({"custom-pointer":!l.disabled}),style:nt({display:x(qe)<=768?l.display:""}),onClick:Rt=>Se(l),disabled:l.disabled},{default:t(()=>[m(I(l.title)+" ",1),e(o,{class:"ml-1",icon:"mdi-chevron-right"})]),_:2},1032,["class","style","onClick","disabled"])),64))]),_:1})]),e(R),x(N)("delegate",x(oe))&&Te.value?(D(),$(J,{key:0,modelValue:F.value,"onUpdate:modelValue":a[2]||(a[2]=l=>F.value=l),"max-width":"600",persistent:""},{activator:t(({props:l})=>[e(p,ne({type:"button"},l,{loading:H.value,disabled:g.value,color:"primary",variant:"flat",class:"text-none btnSubmit"}),{default:t(()=>[e(o,{class:"mr-2"},{default:t(()=>[m("mdi-account-arrow-left-outline")]),_:1}),m(" Delegate Engineer ")]),_:2},1040,["loading","disabled"])]),default:t(()=>[e(U,{class:"pa-5"},{default:t(()=>[e(W,{onSubmit:be(Ve,["prevent"]),ref_key:"form",ref:re},{default:t(()=>[e(v,null,{default:t(()=>[e(n,null,{default:t(()=>[bt]),_:1})]),_:1}),e(v,null,{default:t(()=>[e(n,{class:"d-flex justify-center"},{default:t(()=>[e(i,{color:"primary",class:"mt-5",modelValue:ee.value,"onUpdate:modelValue":a[0]||(a[0]=l=>ee.value=l),clearable:"",label:"Delegate to",placeholder:"Delegate to",density:"compact",items:x(Re),variant:"outlined",itemValue:"value",rules:[l=>!!l||"Required",l=>l.key!==void 0?!0:"Select one of the options listed"],itemTitle:"key"},{item:t(({item:l,props:E})=>[e(s,tt(at(E)),{default:t(()=>[e(b,null,{default:t(()=>[V("p",kt,"SBU "+I(l.raw.sbu),1)]),_:2},1024)]),_:2},1040)]),selection:t(({item:l,index:E})=>[V("span",wt,[V("b",null,I(l.title),1),m(),l.title?(D(),Q("span",xt,"- [SBU : "+I(l.raw.sbu)+"]",1)):L("",!0)])]),_:1},8,["modelValue","items","rules"])]),_:1})]),_:1}),e(v,{justify:"end",class:"mt-7 mb-5"},{default:t(()=>[e(p,{variant:"plain",onClick:a[1]||(a[1]=l=>F.value=!1),color:"primary",class:"text-none mr-2"},{default:t(()=>[m(" Cancel")]),_:1}),e(p,{type:"submit",loading:f.value,disabled:g.value,color:"#191970",flat:"",class:"text-none bg-primary mr-5"},{default:t(()=>[e(o,{class:"mr-2"},{default:t(()=>[m("mdi-check")]),_:1}),m(" Delegate")]),_:1},8,["loading","disabled"])]),_:1})]),_:1},512)]),_:1})]),_:1},8,["modelValue"])):L("",!0),x(N)("installer",x(oe))&&Ue.value?(D(),$(J,{key:1,modelValue:T.value,"onUpdate:modelValue":a[7]||(a[7]=l=>T.value=l),"max-width":"600",persistent:""},{activator:t(({props:l})=>[e(p,ne({type:"button"},l,{disabled:g.value,color:"primary",variant:"plain",class:"text-none mr-2",onClick:a[3]||(a[3]=E=>ie("declined"))}),{default:t(()=>[m(" Decline ")]),_:2},1040,["disabled"]),e(p,ne({type:"button"},l,{disabled:g.value,color:"primary",variant:"flat",class:"text-none",onClick:a[4]||(a[4]=E=>ie("accepted"))}),{default:t(()=>[e(o,{class:"mr-2"},{default:t(()=>[m("mdi-check")]),_:1}),m(" Accept ")]),_:2},1040,["disabled"])]),default:t(()=>[e(U,{class:"pa-5"},{default:t(()=>[e(W,{onSubmit:be(he,["prevent"]),ref_key:"formAcceptDecline",ref:ue},{default:t(()=>[e(v,null,{default:t(()=>[e(n,{class:"d-flex justify-center"},{default:t(()=>[e(ae,{modelValue:X.value,"onUpdate:modelValue":a[5]||(a[5]=l=>X.value=l),rules:z.value==="declined"?[l=>!!l||"Required"]:[],label:"Remarks",placeholder:"Remarks",dense:"",rows:"3",variant:"outlined",class:"mt-5 w-100"},null,8,["modelValue","rules"])]),_:1})]),_:1}),e(v,{justify:"end",class:"mt-7 mb-5"},{default:t(()=>[e(p,{variant:"plain",onClick:a[6]||(a[6]=l=>T.value=!1),color:"primary",class:"text-none mr-2"},{default:t(()=>[m(" Cancel")]),_:1}),e(p,{type:"submit",loading:f.value,disabled:g.value,color:"primary",variant:"flat",class:"text-none mr-5"},{default:t(()=>[m(I(z.value==="accepted"?"Accept":"Decline"),1)]),_:1},8,["loading","disabled"])]),_:1})]),_:1},512)]),_:1})]),_:1},8,["modelValue"])):L("",!0),x(N)("installer",x(oe))&&ye.value?(D(),$(p,{key:2,onClick:Ae,text:"Mark as Completed",disabled:g.value,color:"primary",variant:"flat",class:"text-none mr-5"},null,8,["disabled"])):L("",!0)]),default:t(()=>[e($e,{class:"container-form mt-3"},{default:t(()=>[H.value?(D(),Q(se,{key:0},[e(v,null,{default:t(()=>[e(n,{cols:"6"},{default:t(()=>[e(k,{type:"list-item-two-line"})]),_:1}),e(n,{cols:"6"},{default:t(()=>[e(k,{type:"list-item-two-line"})]),_:1})]),_:1}),e(v,null,{default:t(()=>[e(n,{cols:"4"},{default:t(()=>[e(k,{type:"list-item-two-line"})]),_:1}),e(n,{cols:"4"},{default:t(()=>[e(k,{type:"list-item-two-line"})]),_:1}),e(n,{cols:"4"},{default:t(()=>[e(k,{type:"list-item-two-line"})]),_:1})]),_:1}),e(v,null,{default:t(()=>[e(n,{cols:"4"},{default:t(()=>[e(k,{type:"list-item-two-line"})]),_:1}),e(n,{cols:"4"},{default:t(()=>[e(k,{type:"list-item-two-line"})]),_:1}),e(n,{cols:"4"},{default:t(()=>[e(k,{type:"list-item-two-line"})]),_:1})]),_:1})],64)):(D(),Q(se,{key:1},[e(lt,{name:"slide-x-transition"},{default:t(()=>[V("div",null,[e(Z,{class:"ma-2 mt-5",color:"purple",label:""},{default:t(()=>{var l;return[e(Y,{activator:"parent",location:"bottom"},{default:t(()=>[m("Status of Installation")]),_:1}),m("  "+I(((l=pe.value)==null?void 0:l.status)??"---"),1)]}),_:1}),e(gt,{data:S.value},null,8,["data"])])]),_:1}),x(N)("installer",x(ot))&&ye.value?(D(),$(vt,{key:0,modelValue:A.value,"onUpdate:modelValue":a[8]||(a[8]=l=>A.value=l),ref_key:"serviceFormRef",ref:ce},null,8,["modelValue"])):L("",!0),e(ct,{request_data:me.value},null,8,["request_data"]),e(it,{request_data:S.value},null,8,["request_data"])],64)),e(U,{class:"mt-10"},{default:t(()=>[e(K,{modelValue:j.value,"onUpdate:modelValue":a[9]||(a[9]=l=>j.value=l),density:"compact",class:"border-b-sm"},{default:t(()=>[V("div",qt,[e(C,{value:"equipments",class:"text-none"},{default:t(()=>[e(o,{class:"mr-2"},{default:t(()=>[m("mdi-hammer-screwdriver")]),_:1}),m(" Requested Equipments")]),_:1}),e(C,{value:"history",class:"text-none"},{default:t(()=>[e(o,{class:"mr-2"},{default:t(()=>[m("mdi-account-details")]),_:1}),m(" Approval Requirements")]),_:1})]),e(R),V("div",null,[e(C,{value:"delegation_details",class:"text-none",color:"primary"},{default:t(()=>[e(o,{class:"mr-2"},{default:t(()=>[m("mdi-gesture-tap-button")]),_:1}),m(" Delegation Details")]),_:1}),e(C,{value:"service_report",class:"text-none",color:"primary"},{default:t(()=>[e(o,{class:"mr-2"},{default:t(()=>[m("mdi-poll")]),_:1}),m(" Service Report")]),_:1})])]),_:1},8,["modelValue"]),e(Be,null,{default:t(()=>[e(w,{modelValue:j.value,"onUpdate:modelValue":a[10]||(a[10]=l=>j.value=l)},{default:t(()=>[e(_,{value:"equipments"},{default:t(()=>[e(dt,{equipments:te.value},null,8,["equipments"])]),_:1}),e(_,{value:"history"},{default:t(()=>[e(ut,{history:fe.value,status:S.value.main_status},null,8,["history","status"])]),_:1}),e(_,{value:"delegation_details"},{default:t(()=>[e(_t,{internalData:S.value},null,8,["internalData"])]),_:1}),e(_,{value:"service_report"},{default:t(()=>[e(ft,{task_delegation:q.value,actions_taken:ve.value,spareparts:_e.value},null,8,["task_delegation","actions_taken","spareparts"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})}}};export{jt as default};
