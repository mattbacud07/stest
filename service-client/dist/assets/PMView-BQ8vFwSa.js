import{d as Ce,v as Ie,u as Pe,Y as Me,c as Te,x as Ae,g as $e,r as f,J as W,y as Be,f as S,w as t,aI as Ue,T as Fe,S as qe,D as Ne,am as re,o as m,k as L,h as e,p as x,z as Le,F as X,j as r,n as v,I as k,_ as ze,t as J,e as u,Z as Ee,M as Oe,aG as P,N as je,O as Ge}from"./index-BVXPU9zS.js";import{L as He}from"./LayoutSinglePage-Bv3n2_4P.js";import{R as Je,D as Ye,C as Ze,b as Ke,A as Qe,c as We,I as ie,s as ue,S as Xe}from"./maintenance-D6-EqnL4.js";import{_ as et,a as tt,b as at,P as st,c as lt}from"./OperationAfterService-C0QLa4gF.js";import{_ as ot,a as nt,b as rt}from"./ServiceReportForm-0XtmPcpf.js";import{p as it}from"./permitted-CQa1RmFG.js";import{P as ut}from"./PMPrint-CbXTz5lq.js";import{_ as de}from"./VDialog-DfoQvisi.js";import{_ as dt}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./topBarUserProfile-DtdqdVcI.js";import"./getUsers-CWxP2GaZ.js";import"./lodash-CwzxlBFL.js";import"./vue3-datatable-C2ljW4qF.js";const ct=z=>(je("data-v-b7874d0c"),z=z(),Ge(),z),_t={key:2},vt={key:3},mt={key:4},pt={key:0,class:"mt-3 text-danger"},ft=ct(()=>L("div",null,null,-1)),gt={__name:"PMView",setup(z){var le,oe,ne;const h=Ce.useToast(),{width:ce}=Ie(),_e=Pe(),ve=Me(),M=Te(),E=Ae();$e().currentUserRole;const O=f("delegation_details"),{can:R}=it(),me=[{title:"Back",disabled:!1,href:"/preventive-maintenance",display:"block"},{title:"Preventive Maintenance",disabled:!0,href:"",display:"none"},{title:"PM-Details",disabled:!0,href:"",display:"none"}],pe=l=>{!l.disabled&&l.href&&_e.push(l.href)};f(!1);const g=f(!1),p=f(!1),j=f(!1),V=parseInt(ve.params.id),d=f({}),i=f({}),fe=f({}),ee=f([]),te=f([]),T=async()=>{var l,a,s;j.value=!0;try{const n=await E.get("get_pm_record_details",{params:{id:V,module_type:Ue}});if((l=n==null?void 0:n.data)!=null&&l.pm){const o=n.data.pm;d.value=n.data.pm,i.value=o.task_delegation,ee.value=(a=o.task_delegation)==null?void 0:a.actions_taken,te.value=(s=o.task_delegation)==null?void 0:s.spareparts,fe.value=o.latest_task_delegation}else h.error("Something went wrong")}catch(n){console.log(n)}finally{j.value=!1}},ge=[Fe,qe,Ne],ae=(ne=(oe=(le=M.user)==null?void 0:le.user_roles)==null?void 0:oe.find(l=>ge.includes(l.role_id)))==null?void 0:ne.SBU,ye=W(()=>{var l,a,s,n,o;return!!((d.value.status===Je||((l=d.value)==null?void 0:l.status)===Ye)&&(((s=(a=d.value)==null?void 0:a.equipment)==null?void 0:s.sbu)===ae||(o=(n=M.user)==null?void 0:n.user_roles)!=null&&o.some(c=>c.role_id===re)))}),C=f(!1),be=async()=>{var l,a;p.value=!0,g.value=!0;try{const s=await E.post("in-transit",{id:V,delegation_id:(l=i.value)==null?void 0:l.id});(a=s==null?void 0:s.data)!=null&&a.success&&(T(),h.success("Successfull"))}catch(s){console.log(s),p.value=!1,g.value=!1}finally{p.value=!1,g.value=!1}},ke=async()=>{var l,a,s,n;p.value=!0;try{const o=await E.post("start-task",{id:V,delegation_id:(l=i.value)==null?void 0:l.id,in_transit:(n=(s=(a=i.value)==null?void 0:a.task_activity)==null?void 0:s.find(c=>c.status==="In Transit"))==null?void 0:n.acted_at});o.data&&o.data.success&&(h.success("Successfull"),T())}catch(o){console.log(o),p.value=!1}finally{p.value=!1}},se=f(null),A=f({status_after_service:"",fields:[],spareparts:[],remarks:"",complaint:"",problem:"",name:"",designation:"",signature:null}),we=async()=>{var a,s,n,o;if(p.value=!0,g.value=!0,!await((a=se.value)==null?void 0:a.validateServiceForm())){p.value=!1,g.value=!1;return}if(((s=A.value.fields)==null?void 0:s.length)===0){h.error("Required actions taken"),p.value=!1,g.value=!1;return}if([null,void 0].includes(A.value.signature)){h.error("Required signature"),p.value=!1,g.value=!1;return}try{const c=await E.post("pm_mark_as_completed",{id:V,delegation_id:(n=i.value)==null?void 0:n.id,...A.value});(o=c==null?void 0:c.data)!=null&&o.success?(h.success("Completed successfully"),T()):h.error(c.data.error)}catch(c){console.log(c)}finally{p.value=!1,g.value=!1}},$=W(()=>{var s;const l=(s=i.value)==null?void 0:s.assigned_to,a=M.user.id;return l===a}),De=W(()=>{var s,n,o,c,B,I;const l=(s=i.value)==null?void 0:s.assigned_to,a=M.user.id;return!!(((n=d.value)==null?void 0:n.status)===Ze&&(((c=(o=d.value)==null?void 0:o.equipment)==null?void 0:c.sbu)===ae||(I=(B=M.user)==null?void 0:B.user_roles)!=null&&I.some(b=>b.role_id===re||l===a)))}),G=l=>{l===!0&&T()};return Be(async()=>{T()}),(l,a)=>{const s=u("v-icon"),n=u("v-breadcrumbs-item"),o=u("v-tooltip"),c=u("v-breadcrumbs"),B=u("v-spacer"),I=u("v-btn"),b=u("v-skeleton-loader"),D=u("v-col"),Y=u("v-row"),Z=u("v-chip"),K=u("v-tab"),he=u("v-tabs"),Q=u("v-window-item"),Se=u("v-window"),xe=u("v-card-text"),Re=u("v-card"),Ve=u("v-container");return m(),S(He,null,{topBarFixed:t(()=>{var U,F,q,N,y;return[L("div",null,[e(c,{class:"pt-7"},{default:t(()=>[(m(),x(X,null,Le(me,(_,H)=>e(n,{key:H,class:Ee({"custom-pointer":!_.disabled}),onClick:w=>pe(_),style:Oe({display:v(ce)<=768?_.display:""}),disabled:_.disabled},{default:t(()=>[r(J(_.title)+" ",1),e(s,{class:"ml-1",icon:"mdi-chevron-right"})]),_:2},1032,["class","onClick","style","disabled"])),64)),e(s,{color:"grey",onClick:a[0]||(a[0]=_=>G(!0))},{default:t(()=>[e(o,{activator:"parent",location:"bottom"},{default:t(()=>[r("Refresh")]),_:1}),r(" mdi-refresh")]),_:1})]),_:1})]),e(B),L("div",null,[v(R)("delegate",v(P))&&ye.value?(m(),S(et,{key:0,id:v(V),onRefreshData:G},null,8,["id"])):k("",!0),v(R)("installer",v(P))&&$.value&&((U=i.value)==null?void 0:U.status)===Ke?(m(),S(tt,{key:1,id:v(V),delegation_id:(F=i.value)==null?void 0:F.id,onRefreshData:G},null,8,["id","delegation_id"])):k("",!0),v(R)("installer",v(P))&&$.value&&((q=i.value)==null?void 0:q.status)===Qe?(m(),x("div",_t,[e(de,{modelValue:C.value,"onUpdate:modelValue":a[1]||(a[1]=_=>C.value=_),title:"Information",text:"Are you sure to this action?",onConfirm:be},null,8,["modelValue"]),e(I,{type:"button",loading:p.value,disabled:g.value,onClick:a[2]||(a[2]=_=>C.value=!0),color:"primary",variant:"flat",class:"text-none"},{default:t(()=>[e(s,{class:"mr-2"},{default:t(()=>[r("mdi-check")]),_:1}),r("In Transit ")]),_:1},8,["loading","disabled"])])):k("",!0),v(R)("installer",v(P))&&$.value&&((N=i.value)==null?void 0:N.status)===We?(m(),x("div",vt,[e(de,{modelValue:C.value,"onUpdate:modelValue":a[3]||(a[3]=_=>C.value=_),title:"Information",text:"Are you sure to this action?",onConfirm:ke},null,8,["modelValue"]),e(I,{type:"button",loading:p.value,disabled:g.value,onClick:a[4]||(a[4]=_=>C.value=!0),color:"primary",variant:"flat",class:"text-none"},{default:t(()=>[e(s,{class:"mr-2"},{default:t(()=>[r("mdi-check")]),_:1}),r(" Start PM Task")]),_:1},8,["loading","disabled"])])):k("",!0),v(R)("installer",v(P))&&$.value&&((y=i.value)==null?void 0:y.status)===ie?(m(),x("div",mt,[e(I,{onClick:we,text:"Mark as Completed",disabled:g.value,loading:j.value,color:"primary",variant:"flat",class:"text-none mr-5"},null,8,["disabled","loading"])])):k("",!0)])]}),default:t(()=>[e(Ve,{class:"mt-10"},{default:t(()=>{var U,F,q,N;return[j.value?(m(),x(X,{key:0},[e(Y,null,{default:t(()=>[e(D,{cols:"6"},{default:t(()=>[e(b,{type:"list-item-two-line"})]),_:1}),e(D,{cols:"6"},{default:t(()=>[e(b,{type:"list-item-two-line"})]),_:1})]),_:1}),e(Y,null,{default:t(()=>[e(D,{cols:"4"},{default:t(()=>[e(b,{type:"list-item-two-line"})]),_:1}),e(D,{cols:"4"},{default:t(()=>[e(b,{type:"list-item-two-line"})]),_:1}),e(D,{cols:"4"},{default:t(()=>[e(b,{type:"list-item-two-line"})]),_:1})]),_:1}),e(Y,null,{default:t(()=>[e(D,{cols:"4"},{default:t(()=>[e(b,{type:"list-item-two-line"})]),_:1}),e(D,{cols:"4"},{default:t(()=>[e(b,{type:"list-item-two-line"})]),_:1}),e(D,{cols:"4"},{default:t(()=>[e(b,{type:"list-item-two-line"})]),_:1})]),_:1})],64)):(m(),x(X,{key:1},[e(ze,{name:"slide-x-transition"},{default:t(()=>{var y,_,H;return[L("div",null,[e(Z,{class:"ma-2 mt-5",color:ue((y=d.value)==null?void 0:y.status).color,label:""},{default:t(()=>{var w;return[e(o,{activator:"parent",location:"bottom"},{default:t(()=>[r("Status")]),_:1}),r("  "+J(ue((w=d.value)==null?void 0:w.status).text??"---"),1)]}),_:1},8,["color"]),(_=i.value)!=null&&_.status_after_service?(m(),S(Z,{key:0,class:"ma-2 mt-5",color:"indigo",label:""},{default:t(()=>{var w;return[e(o,{activator:"parent",location:"bottom"},{default:t(()=>[r("Status after service")]),_:1}),r("  "+J(((w=i.value)==null?void 0:w.status_after_service)??"---"),1)]}),_:1})):k("",!0),(H=i.value)!=null&&H.tag?(m(),S(Z,{key:1,class:"ma-2 mt-5",color:"warning",label:""},{default:t(()=>{var w;return[e(o,{activator:"parent",location:"bottom"},{default:t(()=>[r("Tag")]),_:1}),r("  "+J(((w=i.value)==null?void 0:w.tag)??"---"),1)]}),_:1})):k("",!0),e(ut,{data:d.value},null,8,["data"])])]}),_:1}),((U=d.value)==null?void 0:U.status)===Xe?(m(),x("p",pt," * The system will automatically update the status to 'Ready for Delegation' and email SBU Head one week before the scheduled date ")):k("",!0),De.value?(m(),S(at,{key:1,data:d.value,onRefreshData:G},null,8,["data"])):k("",!0),v(R)("installer",v(P))&&$.value&&((F=i.value)==null?void 0:F.status)===ie?(m(),S(ot,{key:2,modelValue:A.value,"onUpdate:modelValue":a[5]||(a[5]=y=>A.value=y),ref_key:"serviceFormRef",ref:se,class:"mt-7",type:(N=(q=d.value)==null?void 0:q.task_delegation)==null?void 0:N.type},null,8,["modelValue","type"])):k("",!0),e(st,{customer_details:d.value},null,8,["customer_details"]),e(Re,{class:"mt-10"},{default:t(()=>[e(he,{modelValue:O.value,"onUpdate:modelValue":a[6]||(a[6]=y=>O.value=y),density:"compact",class:"border-b-sm"},{default:t(()=>[L("div",null,[e(K,{value:"delegation_details",class:"text-none",color:"primary"},{default:t(()=>[e(s,{class:"mr-2"},{default:t(()=>[r("mdi-gesture-tap-button")]),_:1}),r(" Delegation Details")]),_:1}),e(K,{value:"service_report",class:"text-none",color:"primary"},{default:t(()=>[e(s,{class:"mr-2"},{default:t(()=>[r("mdi-poll")]),_:1}),r(" Service Report")]),_:1})]),e(B),e(K,{value:"customer_details",class:"text-none",color:"primary"},{default:t(()=>[e(s,{class:"mr-2"},{default:t(()=>[r("mdi-badge-account")]),_:1}),r(" Customer Details")]),_:1}),ft]),_:1},8,["modelValue"]),e(xe,null,{default:t(()=>[e(Se,{modelValue:O.value,"onUpdate:modelValue":a[7]||(a[7]=y=>O.value=y)},{default:t(()=>[e(Q,{value:"delegation_details"},{default:t(()=>[e(nt,{internalData:d.value},null,8,["internalData"])]),_:1}),e(Q,{value:"service_report"},{default:t(()=>[e(rt,{task_delegation:i.value,actions_taken:ee.value,spareparts:te.value},null,8,["task_delegation","actions_taken","spareparts"])]),_:1}),e(Q,{value:"customer_details"},{default:t(()=>[e(lt,{customer_details:d.value},null,8,["customer_details"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})],64))]}),_:1})]),_:1})}}},Tt=dt(gt,[["__scopeId","data-v-b7874d0c"]]);export{Tt as default};
